<!doctype html>
<html>
    <head>
        <title>CICD</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
         <link rel="stylesheet" type="text/css" href="http://w2ui.com/src/w2ui-1.5.rc1.min.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css" type="text/css" charset="utf-8">
        <script src="http://cdn.webix.com/edge/webix.js" type="text/javascript" charset="utf-8"></script>

    
    </head>

    <body>
        <div style="display: none;">
            <div id="list-item-branch">
                <div>
                    <b>#git_branch#</b>
                    <br/>
                    #note#
                    <div>
                        <div style="width: 50%;"><b>Author:</b>#initiator#</div>
                        <div style="width: 50%;" class="show-settings">Settings</div>
                    </div>
                </div>
            </div>
            <div id="branch-details">
                <div>
                    <div>
                    #title#
                    </div>
                    <p>
                    #desc#
                    </p>
                </div>
            </div>
        </div>

        <script>

        function reload_sites() {
            var branch = $$("list-branches").getSelectedItem().git_branch;
            var table = $$("table-branches");
            table.clearAll();
            table.load("/cicd/data/instances?git_branch=" + branch);

            webix.ajax().get('/cicd/data/branches?git_branch=' + branch).then(function(data) {
                var template = $$('webix-branch-details');
                template.data = data.json()[0];
                template.refresh();
            });
        }

        var dumps_promise = webix.ajax().get("/cicd/possible_dumps");
        dumps_promise.then(function(dumps) {
            var dumps = dumps.json();

            webix.ui({
                type: 'wide',
                cols: [
                    {
                        rows: [
                            {
                                view: "template",
                                type: "header",
                                template: "CICD Feature Branches"
                            },
                            {
                                id: 'list-branches',
                                url: '/cicd/data/branches',
                                view: "list",
                                type: {
                                    height: 120,
                                    width: 450,
                                },
                                template: "html->list-item-branch",
                                select: true,
                                on: {
                                    onSelectChange: function () {
                                        reload_sites();
                                    }
                                },
                                onClick:
                                {
                                    "show-settings": function(ev, id){
                                        webix.ajax().get('/cicd/data/branches', {'_id': this.getSelectedItem()}).then(function(data) {
                                            data = data.json();
                                            var form = webix.ui({
                                                view: "window", 
                                                position: 'center',
                                                modal: true,
                                                head: "Settings",
                                                width: 550,
                                                body: {
                                                    view: 'form',
                                                    complexData: true,
                                                    elements: [
                                                        { view:"textarea", name: 'note', label:"Note" },
                                                        { view:"text", name: 'limit_instanes', label:"Limit Instances" },
                                                        { view:"select", name: 'dump', label:"Dump", options: dumps },
                                                        {
                                                            cols:[
                                                                { view:"button", value:"OK", css:"webix_primary", click: function() { 
                                                                    var values = this.getParentView().getFormView().getValues();
                                                                    webix.ajax().post('/cicd/update/branch', values).then(function() {
                                                                        form.hide();
                                                                        // TODO optimize
                                                                        window.location.reload()
                                                                        //var list = $$('list-branches');
                                                                        //list.load(list.url);
                                                                    });
                                                                    }
                                                                },
                                                                { view:"button", value:"Cancel", click: function() {
                                                                    form.hide();
                                                                }}
                                                            ]
                                                        }
                                                    ],
                                                    on: {
                                                        'onSubmit': function() {
                                                            debugger;
                                                        },
                                                    }
                                                }
                                            });
                                            form.getChildViews()[1].setValues(data[0]);
                                            form.show();
                                        });
                                        return false;
                                    }
                                },
                            }
                        ]
                    },
                    {
                        rows: [
                            {
                                id: "webix-branch-details",
                                view: "template",
                                type: "header",
                                template: "html->branch-details",
                                height: 200,
                            },
                            {
                                id: 'table-branches',
                                view: "datatable",
                                select: true,
                                autoConfig: true,
                                editable: true,
                                data: [],
                                autowidth: true,
                                autoheight: true,
                                on: {
                                    onAfterEditStop: function(state, editor, ignoreUpdate) {
                                        var data = {};
                                        data['_id'] = $$("table-branches").getSelectedItem()._id;
                                        data[editor.column] = state.value;
                                        webix.ajax().post('/cicd/update/branch', data);
                                    },
                                },
                                columns:[
                                    { id: 'start_instance', header: '', width: 100, template: "<a href='/cicd/start?name=#name#'>Start</a>"},
                                    // { id: 'run_console', header: '', width: 150, template: "<a href='/'>Console</a>"},
                                    { id: 'name', header: 'Name', width: 150},
                                    { id: 'key', header: 'Type', width: 100},
                                    { id: 'desc', header: 'Description', width: 300, fillspace: true},
                                    { id: 'author', header: 'Author', width: 100},
                                    { id: 'dump', header: 'Dump', width: 200, editor: 'combo', collection: dumps},
                                ],
                            },
                        ]
                    }
                ]
            });

        });
    </script>
    </body>
</html>
